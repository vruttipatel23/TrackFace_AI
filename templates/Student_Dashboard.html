{% extends "base.html" %}

{% block title %}Student Dashboard | FaceTrack AI{% endblock %}

{% block content %}
<main class="container">
    <div class="glass-box dashboard-wide">
        <header class="section-header-split">
            <div>
                <h1>Hello, <span>{{ name }}</span></h1>
                <p>Select a subject to view detailed attendance</p>
            </div>
            <a href="/logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    <i class="fa-solid fa-circle-check"></i> {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="stats-grid">
            {% for sub, data in subject_stats.items() %}
            <div class="subject-card" onclick="showHistory('{{ sub }}', this)">
                <h4>{{ sub }}</h4>
                <div class="percent {{ 'percent-good' if data.percent >= 75 else 'percent-bad' }}">
                    {{ data.percent }}%
                </div>
                <p class="stats-label">{{ data.present }} / {{ data.total }} Lectures</p>
            </div>
            {% endfor %}
        </div>

        <div id="historyWrapper" class="history-section" style="display: none;">
            <h3 id="historyTitle">
                <i class="fa-solid fa-clock-rotate-left"></i> Attendance for <span></span>
            </h3>
            
            <div class="table-responsive">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        {% for rec, sess in records|reverse %}
                        <tr class="att-row" data-subject="{{ sess.subject }}">
                            <td>{{ sess.date }}</td>
                            <td>
                                <span class="status-tag {{ 'tag-present' if rec.status == 'Present' else 'tag-absent' }}">
                                    {{ rec.status }}
                                </span>
                            </td>
                            <td>
                                {% if rec.status == 'Absent' %}
                                <a href="/report-error/{{ rec.id }}" class="report-btn">
                                    <i class="fa-solid fa-triangle-exclamation"></i> Report Error
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    function showHistory(subject, card) {
        const wrapper = document.getElementById('historyWrapper');
        const titleSpan = document.querySelector('#historyTitle span');
        const rows = document.querySelectorAll('.att-row');
        const cards = document.querySelectorAll('.subject-card');

        cards.forEach(c => c.classList.remove('active-card'));
        card.classList.add('active-card');

        titleSpan.innerText = subject;

        rows.forEach(row => {
            if(row.getAttribute('data-subject') === subject) {
                row.style.display = 'table-row';
            } else {
                row.style.display = 'none';
            }
        });

        wrapper.style.display = 'block';
        wrapper.scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}