{% extends "base.html" %}

{% block title %}FaceTrack AI | Registration Form{% endblock %}

{% block content %}
<main class="container">
    <div class="glass-box reg-card form-wide enhanced-reg-form-card">
        <div id="successOverlay" class="success-overlay">
            <div class="success-icon"><i class="fa-solid fa-circle-check"></i></div>
            <h2>Registration Successful!</h2>
            <p>Your account has been created successfully.</p>
            <a href="/login" class="submit-btn enhanced-reg-btn">Go to Login</a>
        </div>

        <header class="reg-form-header">
            <div class="reg-form-icon-wrapper" id="regIconWrapper">
                <i class="fa-solid fa-user-graduate" id="regIcon"></i>
            </div>
            <h2 id="formTitle">Registration</h2>
            <p id="formSubtitle">Fill in your details to create an account</p>
        </header>

        <form id="registrationForm" class="enhanced-reg-form">
            <div class="form-grid enhanced-form-grid">
                <div class="input-group full-width enhanced-reg-input">
                    <label><i class="fa-solid fa-user"></i> Full Name</label>
                    <div class="input-icon-wrapper">
                        <i class="fa-solid fa-id-card input-icon-left"></i>
                        <input type="text" name="full_name" placeholder="Enter your full name" required>
                    </div>
                </div>

                <div class="input-group enhanced-reg-input" id="identifierContainer"></div>
                <div class="input-group enhanced-reg-input" id="genderContainer"></div>
                <div class="input-group enhanced-reg-input" id="subjectContainer"></div>

                <div class="input-group enhanced-reg-input">
                    <label><i class="fa-solid fa-layer-group"></i> Year</label>
                    <select name="year" required>
                        <option value="" disabled selected>Select Year</option>
                        <option value="1">1st Year</option><option value="2">2nd Year</option>
                        <option value="3">3rd Year</option><option value="4">4th Year</option>
                    </select>
                </div>

                <div class="input-group enhanced-reg-input">
                    <label><i class="fa-solid fa-list-ol"></i> Semester</label>
                    <select name="semester" required>
                        <option value="" disabled selected>Select Semester</option>
                        {% for i in range(1, 9) %}<option value="{{ i }}">Semester {{ i }}</option>{% endfor %}
                    </select>
                </div>

                <div class="photo-section full-width" id="photoSection">
                    <label class="multi-upload-box reg-photo-upload" for="photoInput">
                        <input type="file" id="photoInput" accept="image/*" multiple hidden>
                        <div class="upload-icon-wrapper reg-upload-icon">
                            <i class="fa-solid fa-camera"></i>
                        </div>
                        <p id="uploadText" class="upload-text">Upload Face Photos (Min 3)</p>
                        <span class="upload-hint">Required for AI face recognition</span>
                    </label>
                    <div id="previewGrid" class="preview-grid"></div>
                </div>

                <div class="input-group full-width enhanced-reg-input" id="passContainer">
                    <label><i class="fa-solid fa-lock"></i> Password</label>
                    <div class="password-wrapper">
                        <div class="input-icon-wrapper">
                            <i class="fa-solid fa-key input-icon-left"></i>
                            <input type="password" id="passwordField" name="password" placeholder="Create a password">
                        </div>
                        <i class="fa-solid fa-eye toggle-password-icon" id="togglePassword"></i>
                    </div>
                </div>

                <button type="submit" id="regSubmitBtn" class="submit-btn enhanced-reg-submit-btn">
                    <span>Complete Registration</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </form>

        <footer class="form-footer">
            <a href="/register" class="action-card back-link enhanced-back-link">
                <i class="fa-solid fa-arrow-left"></i> Back
            </a>
        </footer>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const role = urlParams.get('role');
    const ADMIN_CODE = "123";

    const regIcon = document.getElementById('regIcon');
    const regIconWrapper = document.getElementById('regIconWrapper');
    const formSubtitle = document.getElementById('formSubtitle');

    if (role === 'faculty') {
        let code = prompt("Enter Admin Code to continue:");
        if (code !== ADMIN_CODE) { 
            alert("Unauthorized!");
            window.location.href = "/register"; 
        }
        document.getElementById('formTitle').innerText = "Faculty Registration";
        formSubtitle.innerText = "Enter your details to register as faculty";
        regIcon.className = "fa-solid fa-user-tie";
        regIconWrapper.className = "reg-form-icon-wrapper faculty-icon-bg";
        document.getElementById('identifierContainer').innerHTML = '<label><i class="fa-solid fa-envelope"></i> Email</label><div class="input-icon-wrapper"><i class="fa-solid fa-envelope input-icon-left"></i><input type="email" name="email" placeholder="Faculty email address" required></div>';
        document.getElementById('subjectContainer').innerHTML = '<label><i class="fa-solid fa-book"></i> Subject</label><div class="input-icon-wrapper"><i class="fa-solid fa-graduation-cap input-icon-left"></i><input type="text" name="subject" placeholder="Subject name" required></div>';
        document.getElementById('genderContainer').style.display = 'none';
        document.getElementById('photoSection').style.display = 'none';
        document.getElementById('passContainer').style.display = 'none';
    } else {
        document.getElementById('formTitle').innerText = "Student Registration";
        formSubtitle.innerText = "Enter your details and upload face photos for AI recognition";
        regIcon.className = "fa-solid fa-user-graduate";
        regIconWrapper.className = "reg-form-icon-wrapper student-icon-bg";
        document.getElementById('identifierContainer').innerHTML = '<label><i class="fa-solid fa-id-card"></i> Enrollment No</label><div class="input-icon-wrapper"><i class="fa-solid fa-hashtag input-icon-left"></i><input type="text" name="enroll" placeholder="Enrollment number" required></div>';
        document.getElementById('genderContainer').innerHTML = `<label><i class="fa-solid fa-venus-mars"></i> Gender</label><select name="gender" required><option value="" disabled selected>Select Gender</option><option value="Male">Male</option><option value="Female">Female</option></select>`;
        document.getElementById('subjectContainer').style.display = 'none';
        document.getElementById('photoSection').style.display = 'block';
        document.getElementById('passwordField').required = true;
    }

    document.getElementById('togglePassword').addEventListener('click', function() {
        const passField = document.getElementById('passwordField');
        passField.type = passField.type === 'password' ? 'text' : 'password';
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
    });

    document.getElementById('photoInput').addEventListener('change', function() {
        const grid = document.getElementById('previewGrid');
        const status = document.getElementById('uploadText');
        grid.innerHTML = '';
        const files = Array.from(this.files);
        status.innerText = files.length + " Photos Selected";
        files.forEach(f => {
            const r = new FileReader();
            r.onload = (e) => {
                const i = document.createElement('img');
                i.src = e.target.result;
                i.className = 'preview-thumb';
                grid.appendChild(i);
            };
            r.readAsDataURL(f);
        });
    });

    document.getElementById('registrationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('regSubmitBtn');
        const originalText = submitBtn.innerText;
        submitBtn.innerText = "Processing AI Face Scan...";
        submitBtn.disabled = true;
        const formData = new FormData(this);
        if (role === 'student') {
            const photos = document.getElementById('photoInput').files;
            if (photos.length < 3) {
                alert("Min 3 photos required for AI Training!");
                submitBtn.innerText = originalText; submitBtn.disabled = false;
                return;
            }
            for (let i=0; i<photos.length; i++) formData.append('photos', photos[i]);
        }
        fetch(role === 'faculty' ? '/register-faculty' : '/register-student', { 
            method: 'POST', 
            body: formData 
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                document.getElementById('successOverlay').style.display = 'flex';
            } else {
                alert("Registration Failed: " + data.message);
                submitBtn.innerText = originalText; submitBtn.disabled = false;
            }
        })
        .catch(err => {
            alert("Server Connection Error!");
            submitBtn.innerText = originalText; submitBtn.disabled = false;
        });
    });
</script>
{% endblock %}